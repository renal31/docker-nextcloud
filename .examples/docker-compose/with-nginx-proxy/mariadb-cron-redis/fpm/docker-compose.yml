version: '2'

services:
  db:
    container_name: nextcloud-db
    image: mariadb
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
    restart: always
    volumes:
      - ${DB_HOST_MOUNT}:/var/lib/mysql
      - /etc/localtime:/etc/localtime:ro
    environment:
      - MYSQL_ROOT_PASSWORD=sun6urn31
    env_file:
      - db.env

  redis:
    container_name: nextcloud-redis
    image: redis:alpine
    restart: always

  app:
    container_name: nextcloud-app
    image: nextcloud:fpm-alpine
    restart: always
    volumes:
      - ${APP_HOST_MOUNT}:/var/www/html
      - ${EXT_DATA_HOST_ACCESS}:/srv
      - /etc/localtime:/etc/localtime:ro
    environment:
      - MYSQL_HOST=db
      - REDIS_HOST=redis
    env_file:
      - db.env
    expose:
      - '80'
      - '9000'
    depends_on:
      - db
      - redis
    networks:
      - default

  onlyoffice-document-server:
    container_name: onlyoffice-document-server
    image: onlyoffice/documentserver:latest
    restart: always
    expose:
      - '80'
      - '443'
    volumes:
      - ${OFFICE_HOST_MOUNT}/data:/var/www/onlyoffice/Data
      - ${OFFICE_HOST_MOUNT}/log:/var/log/onlyoffice
    environment:
      - VIRTUAL_HOST=${OFFICE_DOMAIN}
      - LETSENCRYPT_HOST=${OFFICE_DOMAIN}
      - LETSENCRYPT_EMAIL=admin@noan.me
    networks:
      - proxy-tier
      - default

  web:
    container_name: nextcloud-web
    build: ./web
    restart: always
    volumes:
      - ${APP_HOST_MOUNT}:/var/www/html:ro
    environment:
      - VIRTUAL_HOST=${NC_DOMAIN}
      - LETSENCRYPT_HOST=${NC_DOMAIN}
      - LETSENCRYPT_EMAIL=admin@noan.me
    depends_on:
      - app
    networks:
      - proxy-tier
      - default

  cron:
    container_name: nextcloud-cron
    image: nextcloud:fpm-alpine
    restart: always
    volumes:
      - ${APP_HOST_MOUNT}:/var/www/html
    entrypoint: /cron.sh
    depends_on:
      - db
      - redis

networks:
  proxy-tier:
    external:
      name: proxy-ssl
